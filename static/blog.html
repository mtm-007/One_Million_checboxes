<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Building One Million Checkboxes</title>
<style>
* { box-sizing: border-box; margin: 0; padding: 0; }
body {
    background: #fff;
    color: #333;
    font-family: "Palatino Linotype", "Book Antiqua", Palatino, Georgia, serif;
    font-size: 18px;
    line-height: 1.7;
    -webkit-font-smoothing: antialiased;
}
nav.blog-nav {
    border-bottom: 1px solid #e8e8e8;
    padding: 12px 0;
}
.blog-nav-inner {
    max-width: 1100px;
    margin: 0 auto;
    padding: 0 30px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
}
.blog-nav-home {
    font-size: 17px;
    font-weight: bold;
    color: #000;
    text-decoration: none;
}
.blog-nav-links { display: flex; gap: 24px; }
.blog-nav-links a { font-size: 14px; color: #555; text-decoration: none; }
.blog-nav-links a:hover { color: #000; }
.blog-container {
    max-width: 1100px;
    margin: 0 auto;
    padding: 36px 30px 100px;
    display: flex;
    gap: 56px;
    align-items: flex-start;
}
.blog-sidebar {
    width: 200px;
    flex-shrink: 0;
    position: sticky;
    top: 24px;
    font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
    font-size: 13px;
    line-height: 1.5;
}
.blog-sidebar-title {
    font-size: 11px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.07em;
    color: #bbb;
    margin-bottom: 10px;
}
.blog-sidebar ul { list-style: none; padding: 0; }
.blog-sidebar > ul > li { margin-bottom: 8px; }
.blog-sidebar ul ul { padding-left: 12px; margin-top: 4px; }
.blog-sidebar ul ul li { margin-bottom: 4px; }
.blog-sidebar a { color: #666; text-decoration: none; display: block; }
.blog-sidebar a:hover { color: #000; }
.blog-article-col { flex: 1; min-width: 0; }
.blog-post-header { margin-bottom: 32px; }
.blog-post-header h1 {
    font-family: "Palatino Linotype", "Book Antiqua", Palatino, Georgia, serif;
    font-size: 38px;
    font-weight: bold;
    color: #111;
    line-height: 1.2;
    letter-spacing: -0.01em;
    margin-bottom: 8px;
}
.blog-post-meta {
    font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
    font-size: 14px;
    color: #aaa;
    display: flex;
    gap: 8px;
    align-items: center;
    flex-wrap: wrap;
}
.meta-sep { color: #ddd; }
.meta-tag {
    background: #f5f5f5;
    border-radius: 3px;
    padding: 1px 7px;
    color: #888;
    font-size: 11px;
}
.blog-article {
    font-family: "Palatino Linotype", "Book Antiqua", Palatino, Georgia, serif;
    font-size: 18px;
    line-height: 1.7;
    color: #333;
}
.blog-article p { margin-bottom: 20px; }
.blog-article > p:first-child { font-size: 19px; color: #222; }
.blog-article h2 {
    font-family: "Palatino Linotype", "Book Antiqua", Palatino, Georgia, serif;
    font-size: 28px; font-weight: bold; color: #111;
    margin: 48px 0 14px; line-height: 1.3;
}
.blog-article h3 {
    font-family: "Palatino Linotype", "Book Antiqua", Palatino, Georgia, serif;
    font-size: 22px; font-weight: bold; color: #222;
    margin: 36px 0 12px;
}
.blog-article h4 {
    font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
    font-size: 15px; font-weight: bold; color: #333; margin: 28px 0 8px;
}
.blog-article strong { color: #111; }
.blog-article em { font-style: italic; }
.blog-article a { color: #2a7ae2; text-decoration: none; }
.blog-article a:hover { text-decoration: underline; }
.blog-article code {
    font-family: Menlo, Monaco, "Courier New", monospace;
    font-size: 14px; background: #f5f5f5; border: 1px solid #ddd;
    color: #c7254e; padding: 1px 5px; border-radius: 3px;
}
.blog-article pre {
    background: #f8f8f8; border: 1px solid #ddd; border-radius: 3px;
    padding: 14px 18px; overflow-x: auto; margin: 20px 0; line-height: 1.55;
}
.blog-article pre code {
    background: none; border: none; padding: 0;
    color: #333; font-size: 13.5px; white-space: pre;
}
.blog-article blockquote {
    border-left: 4px solid #ddd; padding: 4px 0 4px 18px;
    margin: 24px 0; color: #666; font-style: italic;
}
.blog-article hr { border: none; border-top: 1px solid #eee; margin: 40px 0; }
.blog-article ul { list-style: disc; padding-left: 28px; margin-bottom: 20px; }
.blog-article ol { list-style: decimal; padding-left: 28px; margin-bottom: 20px; }
.blog-article li { margin-bottom: 6px; color: #333; }
.blog-footer {
    margin-top: 60px; padding-top: 24px; border-top: 1px solid #eee;
    display: flex; gap: 10px; flex-wrap: wrap;
    font-family: "Helvetica Neue", Helvetica, Arial, sans-serif; font-size: 13px;
}
.blog-footer a {
    color: #555; text-decoration: none; padding: 5px 12px;
    border: 1px solid #ddd; border-radius: 3px; background: #fafafa;
}
.blog-footer a:hover { color: #000; border-color: #aaa; background: #f0f0f0; }
@media (max-width: 780px) {
    .blog-container { flex-direction: column; gap: 0; padding: 24px 20px 80px; }
    .blog-sidebar { display: none; }
    .blog-post-header h1 { font-size: 28px; }
    .blog-article { font-size: 17px; }
    .blog-article h2 { font-size: 23px; }
}
</style>
</head>
<body>

<nav class="blog-nav">
  <div class="blog-nav-inner">
    <a href="/" class="blog-nav-home">One Million Checkboxes üßÄ</a>
    <div class="blog-nav-links">
      <a href="/visitors">Visitors</a>
      <a href="https://github.com/mtm-007/One_Million_checboxes" target="_blank">GitHub ‚Üó</a>
    </div>
  </div>
</nav>

<div class="blog-container">
  <aside class="blog-sidebar">
    <div class="blog-sidebar-title">Table of Contents</div>
    <ul>
      <li><a href="#the-core-idea">The Core Idea</a></li>
      <li><a href="#the-bitmap-trick">The Bitmap Trick</a></li>
      <li><a href="#real-time-without-websockets">Real-Time Without WebSockets</a></li>
      <li><a href="#full-architecture">The Full Architecture</a></li>
      <li><a href="#painful-adventures">The Painful Adventures & Bugs I Fixed</a></li>
      <li><a href="#what-id-do-differently">What I‚Äôd Do Differently Next Time</a></li>
      <li><a href="#takeaways">Takeaways After 227 Commits</a></li>
    </ul>
  </aside>

  <div class="blog-article-col">
    <header class="blog-post-header">
      <h1>Building One Million Checkboxes</h1>
      <div class="blog-post-meta">
        Feb 23, 2026
        <span class="meta-sep">¬∑</span>
        ~10 min read
        <span class="meta-sep">¬∑</span>
        <span class="meta-tag">FastHTML</span>
        <span class="meta-tag">Redis</span>
        <span class="meta-tag">Modal</span>
        <span class="meta-tag">HTMX</span>
      </div>
    </header>

    <div class="blog-article">
      <p>A few months ago I had a silly idea: build a real-time collaborative grid with <em>exactly one million checkboxes</em> ‚Äî anyone on the internet clicks, everyone sees it instantly. No login, no accounts, pure shared chaos. It sounded simple. It absolutely was not.</p>

      <p>The app is live right now at <a href="https://mtm-007--fasthtml-checkboxes-web.modal.run/">mtm-007--fasthtml-checkboxes-web.modal.run</a>. Go click a few. Someone across the world will see them flip. That still blows my mind.</p>

      <p>This is the full story ‚Äî every terrible idea, every data-loss panic, every ‚Äúwhy is Redis eating my visitors again?‚Äù, pulled straight from 227 commits, the code, <code>ARCHITECTURE.md</code> diagrams, and many cold-sweat debugging nights.</p>

      <hr />

      <h2 id="the-core-idea">The Core Idea (and Why Na√Øve Approaches Explode)</h2>

      <p>Store one million booleans? Easy, right?<br /><strong>Wrong.</strong> A Python list or JSON blob ‚âà 8 MB. Every toggle and render would murder memory and Redis. Thousands of concurrent visitors? Dead server.</p>

      <h3 id="the-bitmap-trick">The Bitmap Trick That Saved Everything</h3>

      <p>Redis bitmaps: 1,000,000 bits = <strong>exactly 125 KB</strong>.</p>
      <pre><code>SETBIT checkboxes_bitmap 42069 1   ‚Üí check #42,069
GETBIT checkboxes_bitmap 42069     ‚Üí read it
BITCOUNT checkboxes_bitmap         ‚Üí live ‚ÄúX / 1,000,000 checked‚Äù stats</code></pre>

      <p>One key, one command per toggle/read, tiny memory. This turned impossible into ‚Äúruns happily on tiny Modal container‚Äù.</p>

      <h2 id="real-time-without-websockets">Real-Time Without WebSockets (The HTMX Polling Hack)</h2>

      <p>No WebSocket state, reconnections, heartbeats in prod. Instead: HTMX heresy.</p>

      <ul>
        <li>Every client polls <code>/diffs/{client_id}</code> every 500 ms</li>
        <li>Toggle ‚Üí server adds index to per-client diff queues</li>
        <li>Next poll ‚Üí client gets only changes, OOB swap</li>
      </ul>

      <p>Max 500 ms latency, zero server connection management, scales trivially. Still love this choice.</p>

      <h2 id="full-architecture">The Full Architecture (What Actually Ships)</h2>

      <ul>
        <li><strong>Frontend</strong>: FastHTML + HTMX + responsive CSS (mobile-first, lazy-load 2,000-checkbox chunks)</li>
        <li><strong>Backend</strong>: FastHTML (Python 3.12, async)</li>
        <li><strong>State</strong>: Redis bitmap (hot path) + in-memory client dict + 45s page cache for dashboards</li>
        <li><strong>Analytics</strong>: Geo fallback (ipwho.is ‚Üí ipapi.co ‚Üí ip-api.com), bot/VPN classification, referrer parsing (GitHub iframe fix), time-spent heartbeats, scroll-depth, actions</li>
        <li><strong>Persistence</strong>: Modal volume + Redis RDB + SQLite backup/restore (saved me repeatedly)</li>
        <li><strong>Deployment</strong>: Modal serverless + GitHub Actions CI/CD (zero-downtime auto-scaling)</li>
      </ul>

      <p>Full Mermaid diagrams and flows in <code>ARCHITECTURE.md</code> ‚Äî sequence for toggles, visitor tracking flowchart, layer graph, performance Gantt/pie charts.</p>

      <hr />

      <h2 id="painful-adventures">The Painful Adventures & Bugs I Fixed</h2>

      <ol>
        <li><strong>‚ÄúRedis overwrite ate my visitor data‚Äù (multiple times)</strong><br />Early Redis hashes, no backup. Redeploy ‚Üí container dies ‚Üí gone (even volumes if snapshot bad).<br /><strong>Fix</strong>: <code>persistence.py</code> SQLite backup on shutdown + restore on startup. Feb 23 commit: ‚Äúblog visitors record lost issue fixed with adding lifespan on starlette‚Äù ‚Äî moved to Starlette lifespan (not old web_app hooks).</li>

        <li><strong>GitHub Referrer Black Hole</strong><br />README traffic showed ‚ÄúDirect‚Äù. GitHub iframes use <code>referrerpolicy="no-referrer"</code>.<br /><strong>Fix</strong>: UTM in README link + code fallback. Now correctly ‚Äúsocial referral‚Äù.</li>

        <li><strong>Mermaid Diagram Nightmares in README</strong><br />### NEW comments break parser, parentheses ‚Üí stadium nodes, en-dashes in ranges illegal, ‚Üí arrows fail.<br />Many commits: ‚Äúfix mermaid again‚Äù, ‚Äúcheck updated readme‚Äù.</li>

        <li><strong>Blog Visitors Tracking Saga (Feb 21‚Äì23 2026)</strong><br />Added blog tracking (scroll, actions, time spent, referrer) ‚Üí explosion: wrong time math, scroll not persisting, HTML vs FastHTML bugs, parenthesis typos, shutdown loss.<br /><strong>Fixes</strong>: Starlette lifespan, heartbeat + beforeunload beacon, chunk scroll math. Commits: ‚Äúfix time spent and scroll in blog visits‚Äù, ‚Äútemporary reset for total time spent error‚Äù, ‚Äúgetting the scroll and actions data‚Äù.</li>

        <li><strong>Refactoring Hell & Code Archaeology</strong><br />Scattered files: <code>one_M_checkboxes_old.py</code>, prototypes, logs. Moved to <code>checkboxes_v0/</code>, <code>monetization_prop/</code>. Early JSON lists ‚Üí nightmares. Commits cleaning up, fewer lines.</li>

        <li><strong>Serverless Gotchas on Modal</strong><br />Redis as subprocess, forced <code>volume.commit.aio()</code> on shutdown, logs survival, multi-container Redis sharing (client manager graceful).</li>
      </ol>

      <h2 id="what-id-do-differently">What I‚Äôd Do Differently Next Time</h2>

      <ul>
        <li>Redis Pub/Sub over polling ‚Üí instant, less chatty</li>
        <li>Rate limiting (Redis token bucket per IP)</li>
        <li>Separate analytics DB (Redis great for bitmap, overkill for history)</li>
        <li>Cloudflare bot management upstream</li>
        <li>Pre-commit hooks day one (parenthesis ghosts haunt me)</li>
      </ul>

      <h2 id="takeaways">Takeaways After 227 Commits</h2>

      <ul>
        <li><strong>Bitmaps are magic</strong>. Millions of booleans? Redis bitmaps first.</li>
        <li><strong>Referer header lies</strong>. Ship UTM always.</li>
        <li><strong>Serverless + volumes incredible</strong>, but master shutdown/lifespan.</li>
        <li><strong>FastHTML + HTMX stupidly productive</strong>. Full-stack Python, no build step. Joy.</li>
        <li><strong>Persistence never afterthought</strong>. SQLite backup/restore saved me repeatedly.</li>
        <li><strong>Small bugs compound</strong>. Missing await, extra parenthesis, aggressive TTL ‚Üí lying analytics.</li>
      </ul>

      <p>Started as weekend toy, became masterclass in system design, load debugging, fast shipping with modern Python.</p>

      <p>See the chaos:<br />
      ‚Ä¢ Repo: <a href="https://github.com/mtm-007/One_Million_checboxes">github.com/mtm-007/One_Million_checboxes</a><br />
      ‚Ä¢ <code>ARCHITECTURE.md</code> for diagrams<br />
      ‚Ä¢ <code>persistence.py</code> for backup/restore dance<br />
      ‚Ä¢ <code>main.py</code> for bitmap + diff queue magic</p>

      <p>Go click some boxes. Leave it more chaotic. Build something similar? Drop a link ‚Äî I want to see your lessons.</p>

      <p>Happy hacking,<br />
      mera<br />
      (Feb 23, 2026 ‚Äî after yet another ‚Äúfix time spent and scroll in blog visits‚Äù commit)</p>
    </div>

    <footer class="blog-footer">
      <a href="/visitors">‚Üê Back to Visitors</a>
      <a href="/">‚Üê Back to Checkboxes</a>
      <a href="https://github.com/mtm-007/One_Million_checboxes" target="_blank">View Source ‚Üó</a>
    </footer>
  </div>
</div>
<script>
    const tracker = {
        startTime: Date.now(), lastHeartbeat: Date.now(), scrollDepth: 0,
        initialized: false,
    
        init() {
            if (this.initialized) return;
            this.initialized = true;
            this.startTime = Date.now();
            this.actionCount = 0;
            this.scrollDepth = 0;

            ['click', 'keypress', 'touchstart'].forEach(evt =>{
                document.addEventListener(evt, () =>{ this.actionCount++; }, { passive: true});
            });
    
            this.sendHeartbeat();
            setInterval(() => { this.sendHeartbeat(); }, 1000);
    
            let scrollTimer;
            window.addEventListener('scroll', () => {
                clearTimeout(scrollTimer);
                scrollTimer = setTimeout(() => {
                    const depth = Math.round((window.scrollY / (document.body.scrollHeight - window.innerHeight)) * 100);
                    this.scrollDepth = Math.max(this.scrollDepth, isNaN(depth) ? 0 : depth);
                    fetch('/track-scroll', { method: 'POST', headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({depth: this.scrollDepth})
                    }).catch(() => {});
                }, 500);
            });
    
            window.addEventListener('beforeunload', () => { this.endSession(); });
            window.addEventListener('pagehide', () => { this.endSession(); });
        },
        sendHeartbeat() {
            const duration = (Date.now() - this.startTime) / 1000;
            fetch('/heartbeat', { method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ duration, actions: this.actionCount || 0, timestamp: Date.now() }), keepalive: true
            }).catch(() => {});
            this.lastHeartbeat = Date.now();
        },
    
        endSession() {
            if(this.sessionEnded)return;
            this.sessionEnded = true;

            const duration = (Date.now() - this.startTime) / 1000;
            const data = { duration, scrollDepth: this.scrollDepth, timestamp: Date.now(), source: "blog" };
            if (navigator.sendBeacon) {
                navigator.sendBeacon('/session-end', new Blob([JSON.stringify(data)], {type: 'application/json'}));
            } else {
                fetch('/session-end', { method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data), keepalive: true }).catch(() => {});
            }
        }
    };
    
    // ‚úÖ visibilitychange is OUTSIDE init() so it always fires
    document.addEventListener('visibilitychange', () => {
        if (!document.hidden) {
            tracker.startTime = Date.now();
            tracker.actionCount = 0;
            tracker.sessionEnded = false;
            tracker.init();  // start tracking if not already started
            fetch('/track-blog-view', { method: 'POST', keepalive: true }).catch(() => {});
            tracker.sendHeartbeat();
        } else {
            tracker.endSession();
        }
    });
    
    tracker.init(); // also init on full page load
</script>
</body>
</html>